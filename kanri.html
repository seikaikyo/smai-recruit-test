<!DOCTYPE html>
<html lang="zh-TW" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAI 測驗管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.22/dist/full.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        [v-cloak] { display: none; }
        body { background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); min-height: 100vh; }
        .personality-bar { height: 8px; border-radius: 4px; background: #e0e0e0; }
        .personality-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
    </style>
</head>
<body>
<div id="app" v-cloak class="min-h-screen">
    <!-- Login -->
    <div v-if="!isLoggedIn" class="flex items-center justify-center min-h-screen">
        <div class="card bg-base-100 shadow-xl w-96">
            <div class="card-body">
                <h2 class="card-title justify-center mb-4">SMAI 測驗管理後台</h2>
                <p class="text-sm opacity-70 mb-4 text-center">請輸入管理員帳號登入 (預設: admin / 123456)</p>
                <div v-if="loginError" class="alert alert-error text-sm mb-4">{{ loginError }}</div>
                <div class="form-control">
                    <label class="label"><span class="label-text">員工編號</span></label>
                    <input v-model="employeeId" type="text" class="input input-bordered" placeholder="請輸入員工編號" @keyup.enter="login">
                </div>
                <div class="form-control mt-2">
                    <label class="label"><span class="label-text">PIN 碼</span></label>
                    <input v-model="pin" type="password" class="input input-bordered" placeholder="請輸入 PIN 碼" maxlength="6" @keyup.enter="login">
                </div>
                <button class="btn btn-primary mt-4" :class="{ 'loading': loginLoading }" :disabled="loginLoading" @click="login">
                    {{ loginLoading ? '登入中...' : '登入' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div v-else class="p-6">
        <div class="bg-base-100 rounded-box shadow mb-6 p-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <span class="text-xl font-bold">SMAI 測驗管理後台</span>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-2 text-sm opacity-70">
                        <span class="badge badge-neutral">{{ userName }}</span>
                    </div>
                    <button class="btn btn-ghost btn-sm" @click="currentTab === 'results' ? fetchResults() : fetchAuditLogs()">重新整理</button>
                    <button class="btn btn-ghost btn-sm" @click="logout">登出</button>
                </div>
            </div>

            <!-- 頁籤 -->
            <div class="tabs tabs-boxed mt-4 w-fit">
                <a class="tab" :class="{ 'tab-active': currentTab === 'results' }" @click="currentTab = 'results'">測驗結果</a>
                <a class="tab" :class="{ 'tab-active': currentTab === 'audit' }" @click="currentTab = 'audit'; fetchAuditLogs()">稽核日誌</a>
            </div>

            <!-- 篩選區 (只在測驗結果頁籤顯示) -->
            <div v-if="currentTab === 'results'" class="flex flex-wrap gap-4 mt-4">
                <!-- 狀態篩選 -->
                <div>
                    <div class="text-xs opacity-60 mb-1">狀態</div>
                    <div class="join">
                        <input type="radio" name="status" class="join-item btn btn-sm" aria-label="全部"
                            :checked="filterStatus === ''" @change="filterStatus = ''">
                        <input type="radio" name="status" class="join-item btn btn-sm btn-warning" aria-label="待審核"
                            :checked="filterStatus === 'pending'" @change="filterStatus = 'pending'">
                        <input type="radio" name="status" class="join-item btn btn-sm btn-success" aria-label="通過"
                            :checked="filterStatus === 'passed'" @change="filterStatus = 'passed'">
                        <input type="radio" name="status" class="join-item btn btn-sm btn-error" aria-label="不通過"
                            :checked="filterStatus === 'rejected'" @change="filterStatus = 'rejected'">
                    </div>
                </div>

                <!-- 職位篩選 -->
                <div v-if="positions.length">
                    <div class="text-xs opacity-60 mb-1">職位</div>
                    <div class="join flex-wrap">
                        <input type="radio" name="position" class="join-item btn btn-sm" aria-label="全部"
                            :checked="filterPosition === ''" @change="filterPosition = ''">
                        <input v-for="pos in positions" :key="pos" type="radio" name="position"
                            class="join-item btn btn-sm" :aria-label="pos"
                            :checked="filterPosition === pos" @change="filterPosition = pos">
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div v-if="loading" class="text-center py-12">
            <span class="loading loading-spinner loading-lg"></span>
            <p class="mt-2">載入中...</p>
        </div>

        <!-- Results Table -->
        <div v-else-if="currentTab === 'results'" class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>職位</th>
                                <th>分數</th>
                                <th>行為模式</th>
                                <th>狀態</th>
                                <th>提交時間</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="result in filteredResults" :key="result.id" class="hover">
                                <td>
                                    <div class="font-bold">{{ result.name }}</div>
                                    <div class="text-sm opacity-50">{{ result.email }}</div>
                                </td>
                                <td>{{ result.position }}</td>
                                <td>
                                    <span class="font-mono">{{ result.choice_score }}/{{ result.total_choice }}</span>
                                    <div class="text-xs opacity-50">{{ Math.round(result.choice_score / result.total_choice * 100) }}%</div>
                                </td>
                                <td>
                                    <span class="badge" :class="getBehaviorClass(result.behavior_pattern)">
                                        {{ getBehaviorLabel(result.behavior_pattern) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge" :class="getStatusClass(result.status)">
                                        {{ getStatusLabel(result.status) }}
                                    </span>
                                </td>
                                <td class="text-sm">{{ result.created_at }}</td>
                                <td>
                                    <button class="btn btn-ghost btn-xs" @click="viewDetail(result.id)">查看</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div v-if="filteredResults.length === 0" class="text-center py-8 opacity-50">
                    目前沒有測驗結果
                </div>
            </div>
        </div>

        <!-- Audit Logs Table -->
        <div v-else-if="currentTab === 'audit'" class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>時間</th>
                                <th>操作者</th>
                                <th>IP</th>
                                <th>動作</th>
                                <th>描述</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="log in auditLogs" :key="log.id" class="hover">
                                <td class="text-xs whitespace-nowrap">{{ log.created_at }}</td>
                                <td class="text-sm">{{ log.user_email }}</td>
                                <td class="text-xs font-mono">{{ log.ip_address }}</td>
                                <td>
                                    <span class="badge badge-sm" :class="{
                                        'badge-info': log.action === 'view',
                                        'badge-warning': log.action === 'update',
                                        'badge-error': log.action === 'delete'
                                    }">{{ log.action }}</span>
                                </td>
                                <td class="text-sm">{{ log.description }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div v-if="auditLogs.length === 0" class="text-center py-8 opacity-50">
                    目前沒有稽核日誌
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <dialog ref="detailModal" class="modal">
        <div class="modal-box max-w-4xl max-h-[90vh]">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">X</button>
            </form>

            <div v-if="selectedResult">
                <h3 class="font-bold text-lg mb-4">{{ selectedResult.name }} - {{ selectedResult.position }}</h3>

                <!-- 基本資訊 -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="stat bg-base-200 rounded-lg p-3">
                        <div class="stat-title text-xs">選擇題分數</div>
                        <div class="stat-value text-lg">{{ selectedResult.choice_score }}/{{ selectedResult.total_choice }}</div>
                    </div>
                    <div class="stat bg-base-200 rounded-lg p-3">
                        <div class="stat-title text-xs">平均回答時間</div>
                        <div class="stat-value text-lg">{{ selectedResult.avg_response_time?.toFixed(1) || '-' }}s</div>
                    </div>
                    <div class="stat bg-base-200 rounded-lg p-3">
                        <div class="stat-title text-xs">修改答案次數</div>
                        <div class="stat-value text-lg">{{ selectedResult.answer_change_count || 0 }}</div>
                    </div>
                    <div class="stat bg-base-200 rounded-lg p-3">
                        <div class="stat-title text-xs">行為模式</div>
                        <div class="stat-value text-lg">{{ getBehaviorLabel(selectedResult.behavior_pattern) }}</div>
                    </div>
                </div>

                <!-- 人格特質分析 -->
                <div v-if="selectedResult.personality_analysis" class="mb-6">
                    <h4 class="font-bold mb-3">人格特質分析</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div v-for="(trait, key) in selectedResult.personality_analysis" :key="key" class="p-3 bg-base-200 rounded-lg">
                            <div class="text-sm font-medium mb-1">{{ trait.label }}</div>
                            <div class="personality-bar">
                                <div class="personality-fill" :style="{ width: trait.percentage + '%', background: trait.percentage >= 80 ? '#4ade80' : trait.percentage >= 50 ? '#fbbf24' : '#f87171' }"></div>
                            </div>
                            <div class="text-xs mt-1 opacity-70">{{ trait.score }}/{{ trait.total }} ({{ trait.percentage }}%)</div>
                        </div>
                    </div>
                </div>

                <!-- 答題紀錄 -->
                <div class="mb-6">
                    <h4 class="font-bold mb-3">答題紀錄</h4>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        <div v-for="(ans, idx) in selectedResult.answers" :key="idx"
                            class="collapse collapse-arrow bg-base-200">
                            <input type="checkbox">
                            <div class="collapse-title text-sm font-medium flex items-center gap-2">
                                <span class="badge badge-sm" :class="ans.correct === true ? 'badge-success' : ans.correct === false ? 'badge-error' : 'badge-ghost'">
                                    {{ ans.correct === true ? '正確' : ans.correct === false ? '錯誤' : '待審' }}
                                </span>
                                {{ ans.question?.substring(0, 50) }}...
                            </div>
                            <div class="collapse-content text-sm">
                                <p><strong>題目：</strong>{{ ans.question }}</p>
                                <p class="mt-2"><strong>答案：</strong></p>
                                <pre class="whitespace-pre-wrap bg-base-300 p-2 rounded mt-1">{{ ans.answer }}</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 進階挑戰題 -->
                <div v-if="selectedResult.challenge_answers?.length" class="mb-6">
                    <h4 class="font-bold mb-3">進階挑戰題（AI 生成）</h4>
                    <div class="space-y-2">
                        <div v-for="(ans, idx) in selectedResult.challenge_answers" :key="idx"
                            class="collapse collapse-arrow bg-secondary/10">
                            <input type="checkbox">
                            <div class="collapse-title text-sm font-medium">
                                <span class="badge badge-secondary badge-sm mr-2">挑戰 {{ idx + 1 }}</span>
                                {{ ans.question?.substring(0, 50) }}...
                            </div>
                            <div class="collapse-content text-sm">
                                <p><strong>題目：</strong>{{ ans.question }}</p>
                                <p class="mt-2"><strong>答案：</strong></p>
                                <pre class="whitespace-pre-wrap bg-base-300 p-2 rounded mt-1">{{ ans.answer }}</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 審核 -->
                <div class="border-t pt-4">
                    <h4 class="font-bold mb-3">審核操作</h4>
                    <div class="form-control mb-4">
                        <label class="label"><span class="label-text">備註</span></label>
                        <textarea v-model="reviewNotes" class="textarea textarea-bordered" rows="2" placeholder="輸入審核備註..."></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-success" @click="updateStatus('passed')">通過</button>
                        <button class="btn btn-error" @click="updateStatus('rejected')">不通過</button>
                        <button class="btn btn-ghost" @click="updateStatus('reviewed')">標記已審</button>
                    </div>
                </div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
</div>

<script type="module">
import {
    initDB, loginWithPin, verifySession,
    getResults as dbGetResults, getResultById,
    updateReview, getAuditLogs as dbGetAuditLogs
} from './src/db/recruit-db.js';

const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const isLoggedIn = ref(false);
        const loginError = ref('');
        const loginLoading = ref(false);
        const employeeId = ref('');
        const pin = ref('');
        const userName = ref('');
        const loading = ref(false);
        const dbReady = ref(false);
        const currentTab = ref('results');
        const results = ref([]);
        const auditLogs = ref([]);
        const filterStatus = ref('');
        const filterPosition = ref('');
        const selectedResult = ref(null);
        const reviewNotes = ref('');
        const detailModal = ref(null);

        const positions = computed(() => {
            const posSet = new Set(results.value.map(r => r.position));
            return Array.from(posSet);
        });

        const filteredResults = computed(() => {
            return results.value.filter(r => {
                if (filterStatus.value && r.status !== filterStatus.value) return false;
                if (filterPosition.value && r.position !== filterPosition.value) return false;
                return true;
            });
        });

        // 初始化 PGlite 並檢查登入狀態
        const checkExistingSession = async () => {
            loading.value = true;
            try {
                await initDB();
                dbReady.value = true;
            } catch (err) {
                console.error('PGlite 初始化失敗:', err);
                loginError.value = '資料庫初始化失敗，請重新整理頁面';
                loading.value = false;
                return;
            }

            // 檢查 localStorage 中是否有 session
            if (verifySession()) {
                const user = JSON.parse(localStorage.getItem('sso_user') || '{}');
                userName.value = user.name || user.employee_id || '';
                isLoggedIn.value = true;
                await fetchResults();
            }
            loading.value = false;
        };

        const login = async () => {
            loginError.value = '';

            if (!employeeId.value.trim() || !pin.value.trim()) {
                loginError.value = '請輸入員工編號和 PIN 碼';
                return;
            }

            loginLoading.value = true;

            try {
                const data = await loginWithPin(employeeId.value.trim(), pin.value.trim());

                if (data.success) {
                    localStorage.setItem('sso_token', data.data.token);
                    localStorage.setItem('sso_user', JSON.stringify(data.data.user));
                    userName.value = data.data.user.name || data.data.user.employee_id;
                    isLoggedIn.value = true;
                    employeeId.value = '';
                    pin.value = '';
                    fetchResults();
                } else {
                    loginError.value = data.message || '登入失敗';
                }
            } catch (err) {
                console.error('Login error:', err);
                loginError.value = '登入失敗，請確認帳號密碼';
            } finally {
                loginLoading.value = false;
            }
        };

        const logout = () => {
            localStorage.removeItem('sso_token');
            localStorage.removeItem('sso_user');
            isLoggedIn.value = false;
            userName.value = '';
        };

        const fetchResults = async () => {
            loading.value = true;
            try {
                const data = await dbGetResults();
                if (data.success) {
                    results.value = data.data;
                }
            } catch (err) {
                console.error('Failed to fetch results:', err);
            } finally {
                loading.value = false;
            }
        };

        const fetchAuditLogs = async () => {
            loading.value = true;
            try {
                const data = await dbGetAuditLogs();
                if (data.success) {
                    auditLogs.value = data.data;
                }
            } catch (err) {
                console.error('Failed to fetch audit logs:', err);
            } finally {
                loading.value = false;
            }
        };

        const viewDetail = async (id) => {
            try {
                const data = await getResultById(id);
                if (data.success) {
                    selectedResult.value = data.data;
                    reviewNotes.value = data.data.reviewer_notes || '';
                    detailModal.value?.showModal();
                }
            } catch (err) {
                console.error('Failed to fetch detail:', err);
            }
        };

        const updateStatus = async (status) => {
            if (!selectedResult.value) return;
            try {
                const data = await updateReview(
                    selectedResult.value.id, status, reviewNotes.value
                );
                if (data.success) {
                    detailModal.value?.close();
                    fetchResults();
                }
            } catch (err) {
                console.error('Failed to update status:', err);
            }
        };

        const getStatusClass = (status) => {
            switch (status) {
                case 'passed': return 'badge-success';
                case 'rejected': return 'badge-error';
                case 'reviewed': return 'badge-info';
                default: return 'badge-warning';
            }
        };

        const getStatusLabel = (status) => {
            switch (status) {
                case 'passed': return '通過';
                case 'rejected': return '不通過';
                case 'reviewed': return '已審核';
                default: return '待審核';
            }
        };

        const getBehaviorClass = (pattern) => {
            switch (pattern) {
                case 'expert': return 'badge-success';
                case 'careful': return 'badge-info';
                case 'rushing': return 'badge-warning';
                case 'hesitant': return 'badge-ghost';
                default: return 'badge-ghost';
            }
        };

        const getBehaviorLabel = (pattern) => {
            switch (pattern) {
                case 'expert': return '專家型';
                case 'careful': return '謹慎型';
                case 'rushing': return '快速型';
                case 'hesitant': return '猶豫型';
                default: return '-';
            }
        };

        onMounted(() => {
            checkExistingSession();
        });

        return {
            isLoggedIn,
            loginError,
            loginLoading,
            employeeId,
            pin,
            userName,
            loading,
            dbReady,
            currentTab,
            results,
            auditLogs,
            filterStatus,
            filterPosition,
            positions,
            filteredResults,
            selectedResult,
            reviewNotes,
            detailModal,
            login,
            logout,
            fetchResults,
            fetchAuditLogs,
            viewDetail,
            updateStatus,
            getStatusClass,
            getStatusLabel,
            getBehaviorClass,
            getBehaviorLabel
        };
    }
}).mount('#app');
</script>
</body>
</html>
